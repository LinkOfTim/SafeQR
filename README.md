# SafeQR

SafeQR — это демонстрационное приложение для безопасного создания и проверки QR‑кодов. Оно включает веб-интерфейс на FastAPI и классический Tk-интерфейс. После загрузки изображения QR приложение не только извлекает текст или ссылку, но и прогоняет её через набор эвристик, чтобы подсказать, насколько содержимое может быть фишинговым или подозрительным.

## Возможности

- Генерация QR-кодов с автоматической нормализацией URL (поддерживает произвольные текстовые сообщения).
- Сканирование QR с изображений или с камеры (OpenCV + pyzbar).
- Оценка риска ссылки на основе эвристик: проверка схемы, длины, ключевых слов, IP-доменов, punycode/Unicode‑подмены, редиректов и сходства с популярными брендами.
- Встроенный журнал действий (`safeqr.log`) и история последних проверок в веб-интерфейсе.

## Требования

- Python 3.12+.
- Системные пакеты для распознавания QR:
  - Linux: `libzbar0`, `libgl1` (для OpenCV), опционально `python3-tk` для режима Tk.
  - macOS: `brew install zbar tcl-tk`.
  - Windows: достаточно `pip install pyzbar` (пакет приносит готовые бинарники).

## Установка

Рекомендуется разворачивать проект в отдельном виртуальном окружении.

```bash
git clone <repo-url> SafeQR
cd SafeQR
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install --upgrade pip
pip install fastapi uvicorn qrcode[pil] opencv-python pyzbar python-multipart jinja2
```

> Примечание. Если нужен режим Tk, дополнительно установите системный пакет `python3-tk` (Linux) или `brew install python-tk` (macOS). На Windows Tk идёт в комплекте с CPython.

## Запуск

### Веб-режим (по умолчанию)

```bash
python -m safeqr.main --mode web --host 127.0.0.1 --port 8000
```

Приложение поднимет FastAPI/uvicorn и откроет браузер на `http://127.0.0.1:8000`. Параметр `--no-browser` позволит отключить автозапуск браузера.

Доступные маршруты:

- `GET /` — главная страница: формы загрузки/генерации, журнал последних действий.
- `POST /generate` — создаёт QR и отображает его в браузере.
- `POST /scan` — принимает файл с QR, возвращает исходный текст и отчёт безопасности.
- `GET /health` — простой health-check.

### Tk-режим

```bash
python -m safeqr.main --mode tk
```

Требует доступности `tkinter`. Интерфейс позволяет генерировать и сканировать QR без браузера.

## Как пользоваться

1. **Генерация**: введите текст/URL в поле «Создать QR» и отправьте форму. Полученный QR можно скачать с правого клика. Все сгенерированные файлы сохраняются во временную директорию и автоматически удаляются.
2. **Сканирование**: загрузите PNG/JPEG с QR. SafeQR выдаст расшифрованный текст и отчёт безопасности. Также обновится история последних проверок.
3. **Сканирование с камеры**: в Python-скрипте можно вызвать `safeqr.scanner.scan_from_camera()`. Функция откроет камеру и будет ждать QR (по умолчанию 15 секунд).

## Как работает механизм безопасности

Логика находится в `safeqr/security.py`:

- URL нормализуется (`validators.normalize_url`), из него извлекается домен.
- Эвристики добавляют предупреждения:
  - схема не HTTPS;
  - домен — IP-адрес;
  - длина строки > 200 символов;
  - подозрительные ключевые слова (`login`, `bank`, `verify`, …);
  - признаковые параметры редиректа (`?redirect=`, `//@`);
  - доменное имя похоже на известный бренд (SequenceMatcher > 0.82) либо содержит punycode/подозрительный Unicode.
- Уровень риска (`low`, `medium`, `high`) зависит от количества предупреждений: 0 → low, 1‑2 → medium, ≥3 → high.

Каждый запуск сканера или генератора фиксируется в `safeqr.log` (см. `safeqr/utils/logger.py`), а веб-интерфейс показывает «хвост» журнала.

## Тестирование и проверка

Несколько быстрых способов убедиться, что всё работает:

1. **Юнит‑запуск эвристик**:
   ```bash
   python - <<'PY'
   from safeqr.security import check_url_safety
   urls = [
       "http://login.example.com/reset",
       "https://mícrosoft.com",
       "https://example.com?q=gift",
       "https://192.168.0.10/pay",
   ]
   for url in urls:
       print(url, check_url_safety(url))
   PY
   ```
   Вы увидите, какие предупреждения формируются для разных URL.
2. **E2E через веб**: сгенерируйте QR кнопкой «Создать», сохраните его и загрузите в форму «Сканировать». Для негативных сценариев подайте QR со ссылкой из пункта 1.
3. **Камера**: `python - <<'PY'\nfrom safeqr.scanner import scan_from_camera\nprint(scan_from_camera())\nPY` — убедитесь, что камера возвращает строку.

## Полезные пути

- `safeqr/main.py` — точка входа и выбор режима.
- `safeqr/web.py` — FastAPI-приложение и шаблоны.
- `safeqr/generator.py` — код генерации QR.
- `safeqr/scanner.py` — распознавание из файлов и камеры.
- `safeqr/security.py` — оценка риска ссылок.
- `safeqr/utils/validators.py` — вспомогательные функции работы с URL.
- `safeqr/safeqr.log` — журнал событий (создаётся автоматически).

Теперь у вас есть вся информация для установки, запуска и понимания логики SafeQR. Добавляйте собственные эвристики или интегрируйте модуль безопасности в другие проекты.
